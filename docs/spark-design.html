


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Design</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/styles.css" type="text/css" />
  

  
    <link rel="top" title="None" href="index.html"/>
        <link rel="up" title="Spark" href="spark.html"/>
        <link rel="next" title="Stacking" href="spark-stacking.html"/>
        <link rel="prev" title="Overview" href="spark-overview.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> bolt
        

        
          
          <img src="_static/header-logo-small.svg" class="logo" />
        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="overview-motivation.html">Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview-methods.html">Core API</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview-related.html">Related work</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview-thanks.html">Thanks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#backends">Backends</a><ul>
<li class="toctree-l3"><a class="reference internal" href="installation.html#local">Local</a></li>
<li class="toctree-l3"><a class="reference internal" href="installation.html#spark">Spark</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#docker-image">Docker image</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="construction.html">Construction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="construction.html#local">Local</a></li>
<li class="toctree-l2"><a class="reference internal" href="construction.html#spark">Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="construction.html#examples">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="construction.html#detailed-api">Detailed API</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="spark.html">Spark</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="spark-overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#swapping">Swapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transposing-reshaping">Transposing / reshaping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stacking-chunking">Stacking / chunking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="spark-stacking.html">Stacking</a></li>
<li class="toctree-l2"><a class="reference internal" href="spark-chunking.html">Chunking</a></li>
<li class="toctree-l2"><a class="reference internal" href="spark-api.html">API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="spark-api.html#detailed-api">Detailed API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="local.html">Local</a><ul>
<li class="toctree-l2"><a class="reference internal" href="local-overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="local-api.html">API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="local-api.html#detailed-api">Detailed API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">bolt</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="spark.html">Spark</a> &raquo;</li>
      
    <li>Design</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/spark-design.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h1>
<p>Our design stems from several observations we&#8217;ve made working with ndarray-like objects in Spark:</p>
<ul class="simple">
<li>we usually want to parallelize functions across one or more axes, e.g. fitting a model to each of several data points, filtering each of several images, detrending each of several time series</li>
<li>we want to easily and quickly change which axes we parallelize over</li>
<li>we want to chain basic functional parallel operators alongside ndarray-style manipulations</li>
</ul>
<p>How do we achieve this? The primitive object in Spark is a distributed collection of <code class="docutils literal"><span class="pre">key,value</span></code> pair records. The <code class="docutils literal"><span class="pre">BoltArraySpark</span></code> uses keys and values to separately represent axes of a single array. The keys are tuples that encode the indices of the &#8220;parallelized&#8221;
axes, while each value is a NumPy <code class="docutils literal"><span class="pre">ndarray</span></code> representing all the &#8220;localized&#8221; axes. For example, in a <code class="docutils literal"><span class="pre">(2,</span> <span class="pre">3,</span> <span class="pre">4)</span></code> array of ones</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sc</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(2, 3, 4)</span>
</pre></div>
</div>
<p>each key is a tuple</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="go">[(0,), (1,)]</span>
</pre></div>
</div>
<p>and each value is a <code class="docutils literal"><span class="pre">(3,</span> <span class="pre">4)</span></code> array</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()]</span>
<span class="go">[(3, 4), (3, 4)]</span>
</pre></div>
</div>
<p>By convention, the key axes always come before the value axes, and we define an array&#8217;s <code class="docutils literal"><span class="pre">split</span></code> as the number of key axes. During construction or loading, you can decide which axes to use as the keys. For example, just the first</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="go">[(0,), (1,)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">split</span>
<span class="go">1</span>
</pre></div>
</div>
<p>or the first and second</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="go">[(0, 0), (0, 1), (0, 2), (1, 0), (1, 1), (1, 2)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">split</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Array methods are invariant to the choice of split, but performance can be strongly affected, especially when performing parallelized operations.</p>
<div class="section" id="swapping">
<h2>Swapping<a class="headerlink" href="#swapping" title="Permalink to this headline">¶</a></h2>
<p>An important operation on the <code class="docutils literal"><span class="pre">BoltArraySpark</span></code> is changing which axes are parallelized. We call this &#8220;swapping&#8221; because it moves key axes to value axes (or vice versa), and it&#8217;s the core of our <code class="docutils literal"><span class="pre">transpose</span></code> and <code class="docutils literal"><span class="pre">reshape</span></code> implementations.</p>
<p>The <code class="docutils literal"><span class="pre">swap</span></code> function takes a set of key axes that will be moved to value axes, and value axes that will be broken up to become key axes. By convention, the key axes that are swapped to value axes are placed <em>after</em> the split, and the value axes that move to the key axes are placed <em>before</em> the split. In both cases, the new axes have the same order as in the starting array. As examples,</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sc</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(2, 3, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(4, 2, 3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">swap</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(3, 4, 2)</span>
</pre></div>
</div>
<p>One argument can be empty, for example, to move all axes into the keys. In this case, the shape stays the same</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">swap</span><span class="p">((),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(2, 3, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(2, 3, 4)</span>
</pre></div>
</div>
<p>but the split has changed</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">split</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">split</span>
<span class="go">3</span>
</pre></div>
</div>
<p>the keys are now three dimensional</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">[(1, 0, 0), (1, 0, 1), (1, 0, 2), (1, 0, 3), (1, 1, 0)]</span>
</pre></div>
</div>
<p>and there are more records reflecting greater parallelism, as expected</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">tordd</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">24</span>
</pre></div>
</div>
<p>Swapping can be expensive because it incurs a shuffle, but we have leveraged our experience doing these operations at scale to make it as efficient as possible.</p>
<p>To understand our solution, consider two extremes. One one end, we could collect the entire array locally, reslice locally, and redistribute &#8211; but that will fail on out-of-memory datasets. On the other end, we could break up the values into singletons, tag each with an index, and do a massive and expensive shuffle to put them back together.</p>
<p>Our approach is in the middle. We break up the values into &#8220;chunks&#8221;, only along dimensions that are being moved, and use chunk sizes that minimize the number of objects shuffled while avoiding objects that are too large (this is a configurable parameter, but our default has proven efficient at scale in practice).</p>
<p>The entire process is lazy, which helps when composing it with other lazy operations, and properties like <code class="docutils literal"><span class="pre">shape</span></code> and <code class="docutils literal"><span class="pre">split</span></code> are automatically propagated.</p>
</div>
<div class="section" id="transposing-reshaping">
<h2>Transposing / reshaping<a class="headerlink" href="#transposing-reshaping" title="Permalink to this headline">¶</a></h2>
<p>The user-facing functions <code class="docutils literal"><span class="pre">transpose</span></code> and <code class="docutils literal"><span class="pre">reshape</span></code> are generally special cases of <code class="docutils literal"><span class="pre">swap</span></code>, with one small modification: if the desired shape can be achieved by separately and independently manipulating the keys axes or values axes, we can avoid a shuffle, and just apply the neccessary operations via a <code class="docutils literal"><span class="pre">map</span></code>. We identify the neccessary steps for any given requested <code class="docutils literal"><span class="pre">transpose</span></code> or <code class="docutils literal"><span class="pre">reshape</span></code>, and choose the most efficient execution. As with <code class="docutils literal"><span class="pre">swap</span></code>, these operations are lazy, though array properties are immediately updated.</p>
</div>
<div class="section" id="stacking-chunking">
<h2>Stacking / chunking<a class="headerlink" href="#stacking-chunking" title="Permalink to this headline">¶</a></h2>
<p>For more fine-grained control over applying parallel operations to distributed arrays, we provide methods for both <a class="reference internal" href="spark-stacking.html#stacking"><span>Stacking</span></a> (which groups records together for faster vectorized operations) and <a class="reference internal" href="spark-chunking.html#chunking"><span>Chunking</span></a> (which breaks records apart for increased parallelization).</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="spark-stacking.html" class="btn btn-neutral float-right" title="Stacking" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="spark-overview.html" class="btn btn-neutral" title="Overview" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>